{
    "contents" : "---\ntitle: \"Untitled\"\nauthor: \"Diego J. Lizcano\"\ndate: \"August 16, 2015\"\noutput: word_document\nbibliography: C:\\Users\\Diego\\Documents\\CodigoR\\Nancy\\code\\bibliography.bib\ncsl: ecology.csl\n---\n\n\n```{r setup, include=FALSE}\n# cache all... if problem... delete cache folder\nknitr::opts_chunk$set(cache=TRUE)\n```\n\n\n# Relación entre las dos especies de erizos\n\n## Conteos totales sin discriminar sitio.\n\n```{r erizoeplore, cache=TRUE,warning=FALSE,echo=FALSE,fig.height=7,fig.width=7}\nerizodata<-read.csv(\"C:\\\\Users\\\\Diego\\\\Documents\\\\CodigoR\\\\Nancy\\\\data\\\\Erizo_full.csv\")\nlibrary(ggplot2)\n\nprint(cor.test(erizodata$E_thouarsii, erizodata$D_mexicanum ))\n\np6 <- qplot(D_mexicanum, E_thouarsii, data = erizodata)\np6 + stat_smooth() \n\n\n```\n\nEl valor de la correlación es muy bajo y la probabilidad indica que esta es no es significativa. \n\n##Discriminando por el sitio\n```{r erizoeploresite, cache=TRUE,warning=FALSE,echo=FALSE,fig.height=7,fig.width=7}\np6 + stat_smooth() + facet_grid(Sitio ~ .) #+ geom_jitter()\n\n```\nPareciera haber algo en QNG y la Isla de la Plata?\n\n\n\n#Modelo de la abundancia de los erizos\n##Algebra del modelo\n\nAbundance estimation in ecology is usually accomplished by capture-recapture, removal, or distance sampling methods. These may be hard to implement at large spatial scales. In contrast, binomial mixture models enable abundance estimation without individual identification, based simply on temporally and spatially replicated counts [@Kery2005].\n\n\n\nThe N-mixture model or Poisson-Binomial mixture model [@Royle2004]. In this model, all that is required to estimate detection probability and abundance is counts of unmarked individuals that are replicated in two dimensions: there must be a number of sites and there must be a number of replicate observations (i.e., counts) for at least some of the sites. \nThe N-mixture model is a hierarchical extension of the Poisson GLM. We use the Poisson GLM as the base model for N but we regard N as latent variables (i.e., as unobserved or only partly observed). We augment the Poisson GLM with a model that describes how the observations Cij are related to the latent variable Ni. The model is also called a Poisson/binomial mixture model.\n\nAbundance was modeled as a random effect with a Poisson or negative binomial distribution, with mean affected by forest cover, elevation, and route length. Detectability was a logit-linear function of survey date, survey date-by-elevation, and sampling effort (time per transect unit)\n\nbinomial mixture models are an important new approach for estimating abundance corrected for detectability when only repeated-count data are available. \n\n  1. State process:   $$N_{i} \\sim  Poisson (\\lambda )$$\t\n  \n  \n  2. Observation process:\t $$C_{ij} \\sim Binnomial (N_{i} , p_{ij})$$\n  \n\nHere, $N_{i}$ is the latent abundance state at site i (i = 1…M) and $\\lambda$  is the expected abundance, i.e., the mean abundance over all sites. $C_{ij}$  is the count at site i during survey j (j = 1…T) and $p_{ij})$ is the (per-individual) detection probability at site i during survey j.\n\n```{r erizo,eval=FALSE, results='asis',cache=TRUE,warning=FALSE,echo=FALSE,fig.height=4,fig.width=7,message=FALSE}\n\nlibrary(dplyr)\nlibrary(tidyr)\n\nerizodata<-read.csv(\"C:\\\\Users\\\\Diego\\\\Documents\\\\CodigoR\\\\Nancy\\\\data\\\\Erizo_full.csv\")\nerizodata2<-subset(erizodata, Sitio == \"I_Plata\")\n##### select just months 8 to 12 to match alga sampling\n# erizodata<-filter(erizodata2, fecha>=3 ) #x[(x > 0) & (x < 1)]\n# erizodata2<-filter(erizodata, fecha<=6 ) #x[(x > 0) & (x < 1)] \n \nerizo_sp1<-erizodata[,-8]\nerizo_sp2<-erizodata[,-9]\n\n# erizoexpanded<-gather(erizodata, \"transecto\", \"fecha\", c(4:5))\nerizoexpanded_sp1<-spread(erizo_sp1, \"fecha\",\"E_thouarsii\")\nerizoexpanded_sp2<-spread(erizo_sp2, \"fecha\",\"D_mexicanum\")\n\nerizo2_occu<-erizoexpanded_sp2[,3:6] # fix acording to month number\nerizo2_occu[erizo2_occu >0] <-1 # convierte los numeros >0 en uno\n\n######################### Select just 3 first months\nalgadata<-read.csv(\"C:\\\\Users\\\\Diego\\\\Documents\\\\CodigoR\\\\Nancy\\\\data\\\\Alga_PS.csv\")\nalgadata2<-filter(algadata, mes>=8)\nalgadata3<-filter(algadata2, mes<=11)\n\ncovL<-data.frame(cbind(algadata3$sitio,algadata3$mes,algadata3$plot,algadata3$cobertura.Lobophora.variegata))\ncolnames(covL)<-c(\"sitio\", \"mes\",\"plot\",\"biomLobo\")\ncovLobo<-spread(covL, \"mes\",\"biomLobo\")\n# biomaLobo[biomaLobo ==NA] <-0 # convierte los numeros >0 en uno\n\ncovP<-data.frame(cbind(algadata3$sitio,algadata3$mes,algadata3$plot,algadata3$cobertura.Polysiphonia.spp))\ncolnames(covP)<-c(\"sitio\", \"mes\",\"plot\",\"biomLobo\")\ncovPoly<-spread(covP, \"mes\",\"biomLobo\")\n# biomaLobo[biomaLobo ==NA] <-0 # convierte los numeros >0 en uno\n\nvisitMat <- matrix(as.character(1:4), 15, 4, byrow=TRUE)\n\n\nlibrary(unmarked)\numf <- unmarkedFramePCount(y=erizoexpanded_sp2[,3:6], # chane acording to month number\n                           siteCovs= data.frame(\n                             covLobo= apply(covLobo[,3:6],1,FUN = sum),\n                             covPoly=apply(covPoly[,3:6],1,FUN = sum)), \n                           obsCovs = list(obsLobo = covLobo[3:6],\n                                          obsPoly = covPoly[3:6],\n                                          visit=visitMat))\n\nsummary(umf)\n\n# Here's an easy way to standardize covariates after making the UMF\nobsCovs(umf) <- scale(obsCovs(umf))\nsummary(umf)\n\n# Detection covariates follow first tilde, then come abundance covariates\nfm.nmix1 <- pcount(~1 ~1, data=umf, control=list(trace=TRUE, REPORT=2), K=300)\nfm.nmix2 <- pcount(~1 ~covLobo, data=umf, control=list(trace=TRUE, REPORT=2),K=300)\nfm.nmix3 <- pcount(~1 ~covPoly, data=umf, control=list(trace=TRUE, REPORT=2),K=300)\nfm.nmix4 <- pcount(~obsLobo ~1, data=umf, control=list(trace=TRUE, REPORT=2),K=300)\nfm.nmix5 <- pcount(~obsPoly ~1, data=umf, control=list(trace=TRUE, REPORT=2),K=300)\n\nfm.nmix2nb <- pcount(~1 ~covLobo, data=umf, mixture=\"NB\", control=list(trace=TRUE, REPORT=2),K=300)\n\nfm.nmix2zip <- pcount(~1 ~covLobo, data=umf, mixture=\"ZIP\", control=list(trace=TRUE, REPORT=2),K=300)\n\nfm.nmix6 <- pcount(~visit ~1, data=umf, control=list(trace=TRUE, REPORT=2),K=300)\n\n\nmodels <- fitList(\n      'p(.)lambda(.)' = fm.nmix1,\n      'p(.)lambda(covLobo)' = fm.nmix2,\n      'p(.)lambda(covPoly)' = fm.nmix3,\n      'p(obsLobo)lambda(.)' = fm.nmix4,\n      'p(obsPoly)lambda(.)' = fm.nmix5,\n      'p(.)lambda(covLobo)nb' = fm.nmix2nb,\n      'p(.)lambda(covLobo)zip' = fm.nmix2zip,\n      'p(visit)lambda(.)' = fm.nmix6)\n    \n    ms <- modSel(models)\n\nmodelos<-ms@Full\n\nbeta1 <- coef(fm.nmix3) \nplot(function(x) exp(beta1[1] + beta1[2]*x), 0, 15, # no covariates\n     xlab=\"otra_sp\", ylab=\"Expected Abundance\")\n\n\nnewdat <- data.frame(covPoly=c(0:100))\npred<-predict(fm.nmix3, type=\"state\", newdata=newdat, appendData = T)\n\nplot(pred$covPoly,pred$Predicted)\n\n\nmodels<-as.data.frame(cbind(modelos[[1]],modelos[[20]],modelos[[18]],modelos[[21]]))\n\ncolnames(models)<-c(\"model\",\"AIC\",\"nPars\",\"delta\")\n\nprint(knitr::kable(models))\n\n\nplogis(coef(fm.nmix3, type=\"det\")) # Should be close to p\nbackTransform(fm.nmix3, type=\"det\")\n\nplogis(coef(fm.nmix3, type=\"state\"))\n\n\n\n# Empirical Bayes estimation of random effects\n(fm1re <- ranef(fm.nmix1))\nplot(fm1re, subset=site \\%in\\% 1:25, xlim=c(-1,40))\nsum(bup(fm1re))         # Estimated population size\n# Naive population size\nNnaive<-sum(apply(erizoexpanded_sp1[,3:6],2,sum))\n\n\n\n## GoF analysis\n## define a fit statistic\nfreeTuke <- function(fm) {\n  observed <- getY(fm@data)\n  expected <- fitted(fm)\n  sum((sqrt(observed) - sqrt(expected))^2)\n}\n\npb.bestfit <- parboot(fm.nmix3, freeTuke, nsim=300, report=1)\nplot(pb.bestfit)\n\n\n# Function returning three fit-statistics.\nfitstats <- function(fm) {\n    observed <- getY(fm@data)\n    expected <- fitted(fm)\n    resids <- residuals(fm)\n    sse <- sum(resids^2)\n    chisq <- sum((observed - expected)^2 / expected)\n    freeTuke <- sum((sqrt(observed) - sqrt(expected))^2)\n    out <- c(SSE=sse, Chisq=chisq, freemanTukey=freeTuke)\n    return(out)\n    }\n\n(pb <- parboot(fm.nmix3, fitstats, nsim=25, report=1))\nplot(pb, main=\"\")\n\n\n\n```\n\nLa abundancia de la especie 1 de erizo puede ser explicada por la presencia de la otra especie.... Los modelos negative bionomial y zero inflated model no funcionaron muy bien.\n\n\n\n---\n\n#References\n\n\n\n\n\n\n",
    "created" : 1439778643086.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3999557653",
    "id" : "425C0968",
    "lastKnownWriteTime" : 1442411797,
    "path" : "~/CodigoR/Nancy/code/Erizo.Rmd",
    "project_path" : "code/Erizo.Rmd",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "type" : "r_markdown"
}